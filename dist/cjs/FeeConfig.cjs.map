{"version":3,"file":"FeeConfig.cjs","sources":["../../../src/FeeConfig.ts"],"sourcesContent":["import { PublicKey } from \"@solana/web3.js\";\r\nimport { BondingCurveAccount } from \"./BondingCurveAccount.js\";\r\nimport { Layout, struct, u64, bool, publicKey, array } from \"@coral-xyz/borsh\";\r\nimport { GlobalAccount } from \"./GlobalAccount.js\";\r\nimport { BN } from \"@coral-xyz/anchor\";\r\n\r\nexport interface CalculatedFeesBps {\r\n  protocolFeeBps: bigint;\r\n  creatorFeeBps: bigint;\r\n}\r\n\r\nexport interface CalculatedFees {\r\n  protocolFee: bigint;\r\n  creatorFee: bigint;\r\n}\r\n\r\nexport interface FeeTier {\r\n  marketCapLamportsThreshold: bigint;\r\n  fees: Fees;\r\n}\r\n\r\nexport interface Fees {\r\n  lpFeeBps: bigint;\r\n  protocolFeeBps: bigint;\r\n  creatorFeeBps: bigint;\r\n}\r\n\r\nexport interface FeeConfigAnchor {\r\n  admin: PublicKey;\r\n  flatFees: FeesAnchor;\r\n  feeTiers: FeeTierAnchor[];\r\n}\r\n\r\nexport interface FeeTierAnchor {\r\n  marketCapLamportsThreshold: BN;\r\n  fees: FeesAnchor;\r\n}\r\n\r\nexport interface FeesAnchor {\r\n  lpFeeBps: BN;\r\n  protocolFeeBps: BN;\r\n  creatorFeeBps: BN;\r\n}\r\n\r\nexport class FeeConfig {\r\n  public discriminator: bigint;\r\n  public admin: PublicKey;\r\n  public flatFees: Fees;\r\n  public feeTiers: FeeTier[];\r\n\r\n  constructor(\r\n    discriminator: bigint,\r\n    admin: PublicKey,\r\n    flatFees: Fees,\r\n    feeTiers: FeeTier[]\r\n  ) {\r\n    this.discriminator = discriminator;\r\n    this.admin = admin;\r\n    this.flatFees = flatFees;\r\n    this.feeTiers = feeTiers;\r\n  }\r\n\r\n  getFee({\r\n    global,\r\n    bondingCurve,\r\n    amount,\r\n    isNewBondingCurve,\r\n  }: {\r\n    global: GlobalAccount;\r\n    bondingCurve: BondingCurveAccount;\r\n    amount: bigint;\r\n    isNewBondingCurve: boolean;\r\n  }) {\r\n    const { virtualSolReserves, virtualTokenReserves } = bondingCurve;\r\n    const { protocolFeeBps, creatorFeeBps } = this.computeFeesBps({\r\n      global,\r\n      virtualSolReserves,\r\n      virtualTokenReserves,\r\n    });\r\n\r\n    return (\r\n      this.fee(amount, protocolFeeBps) +\r\n      (isNewBondingCurve || !PublicKey.default.equals(bondingCurve.creator)\r\n        ? this.fee(amount, creatorFeeBps)\r\n        : 0n)\r\n    );\r\n  }\r\n\r\n  bondingCurveMarketCap({\r\n    mintSupply,\r\n    virtualSolReserves,\r\n    virtualTokenReserves,\r\n  }: {\r\n    mintSupply: bigint;\r\n    virtualSolReserves: bigint;\r\n    virtualTokenReserves: bigint;\r\n  }): bigint {\r\n    if (virtualTokenReserves === 0n) {\r\n      throw new Error(\r\n        \"Division by zero: virtual token reserves cannot be zero\"\r\n      );\r\n    }\r\n    return (virtualSolReserves * mintSupply) / virtualTokenReserves;\r\n  }\r\n\r\n  computeFeesBps({\r\n    global,\r\n    virtualSolReserves,\r\n    virtualTokenReserves,\r\n  }: {\r\n    global: GlobalAccount;\r\n    virtualSolReserves: bigint;\r\n    virtualTokenReserves: bigint;\r\n  }): CalculatedFeesBps {\r\n    const marketCap = this.bondingCurveMarketCap({\r\n      mintSupply: global.tokenTotalSupply,\r\n      virtualSolReserves,\r\n      virtualTokenReserves,\r\n    });\r\n\r\n    return this.calculateFeeTier({\r\n      feeTiers: this.feeTiers,\r\n      marketCap,\r\n    });\r\n  }\r\n\r\n  calculateFeeTier({\r\n    feeTiers,\r\n    marketCap,\r\n  }: {\r\n    feeTiers: FeeTier[];\r\n    marketCap: bigint;\r\n  }): Fees {\r\n    const firstTier = feeTiers[0];\r\n\r\n    if (marketCap < firstTier.marketCapLamportsThreshold) {\r\n      return firstTier.fees;\r\n    }\r\n\r\n    for (const tier of feeTiers.slice().reverse()) {\r\n      if (marketCap >= tier.marketCapLamportsThreshold) {\r\n        return tier.fees;\r\n      }\r\n    }\r\n\r\n    return firstTier.fees;\r\n  }\r\n\r\n  fee(amount: bigint, feeBasisPoints: bigint): bigint {\r\n    return this.ceilDiv(amount * feeBasisPoints, 10000n);\r\n  }\r\n\r\n  ceilDiv(a: bigint, b: bigint): bigint {\r\n    return (a + (b - 1n)) / b;\r\n  }\r\n\r\n  public static convert(base: FeeConfigAnchor): FeeConfig {\r\n    const flatFees: Fees = {\r\n      lpFeeBps: BigInt(base.flatFees.lpFeeBps.toString()),\r\n      protocolFeeBps: BigInt(base.flatFees.protocolFeeBps.toString()),\r\n      creatorFeeBps: BigInt(base.flatFees.creatorFeeBps.toString()),\r\n    };\r\n\r\n    const feeTiers: FeeTier[] = base.feeTiers.map((tier) => ({\r\n      marketCapLamportsThreshold: BigInt(\r\n        tier.marketCapLamportsThreshold.toString()\r\n      ),\r\n      fees: {\r\n        lpFeeBps: BigInt(tier.fees.lpFeeBps.toString()),\r\n        protocolFeeBps: BigInt(tier.fees.protocolFeeBps.toString()),\r\n        creatorFeeBps: BigInt(tier.fees.creatorFeeBps.toString()),\r\n      },\r\n    }));\r\n\r\n    return new FeeConfig(\r\n      0n, // discriminator not available in FeeConfigAnchor\r\n      base.admin,\r\n      flatFees,\r\n      feeTiers\r\n    );\r\n  }\r\n}\r\n"],"names":["PublicKey"],"mappings":"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"}