{"version":3,"file":"GlobalAccount.cjs","sources":["../../../src/GlobalAccount.ts"],"sourcesContent":["import { PublicKey } from \"@solana/web3.js\";\r\nimport { struct, bool, u64, publicKey, Layout } from \"@coral-xyz/borsh\";\r\n\r\nexport class GlobalAccount {\r\n  public discriminator: bigint;\r\n  public initialized: boolean = false;\r\n  public authority: PublicKey;\r\n  public feeRecipient: PublicKey;\r\n  public initialVirtualTokenReserves: bigint;\r\n  public initialVirtualSolReserves: bigint;\r\n  public initialRealTokenReserves: bigint;\r\n  public tokenTotalSupply: bigint;\r\n  public feeBasisPoints: bigint;\r\n  public withdrawAuthority: PublicKey;\r\n  public enableMigrate: boolean = false;\r\n  public poolMigrationFee: bigint;\r\n  public creatorFeeBasisPoints: bigint;\r\n  public reservedFeeRecipient: PublicKey;\r\n  public mayhemModeEnabled: boolean = false;\r\n\r\n  constructor(\r\n    discriminator: bigint,\r\n    initialized: boolean,\r\n    authority: PublicKey,\r\n    feeRecipient: PublicKey,\r\n    initialVirtualTokenReserves: bigint,\r\n    initialVirtualSolReserves: bigint,\r\n    initialRealTokenReserves: bigint,\r\n    tokenTotalSupply: bigint,\r\n    feeBasisPoints: bigint,\r\n    withdrawAuthority: PublicKey,\r\n    enableMigrate: boolean,\r\n    poolMigrationFee: bigint,\r\n    creatorFeeBasisPoints: bigint,\r\n    reservedFeeRecipient?: PublicKey,\r\n    mayhemModeEnabled: boolean = false\r\n  ) {\r\n    this.discriminator = discriminator;\r\n    this.initialized = initialized;\r\n    this.authority = authority;\r\n    this.feeRecipient = feeRecipient;\r\n    this.initialVirtualTokenReserves = initialVirtualTokenReserves;\r\n    this.initialVirtualSolReserves = initialVirtualSolReserves;\r\n    this.initialRealTokenReserves = initialRealTokenReserves;\r\n    this.tokenTotalSupply = tokenTotalSupply;\r\n    this.feeBasisPoints = feeBasisPoints;\r\n    this.withdrawAuthority = withdrawAuthority;\r\n    this.enableMigrate = enableMigrate;\r\n    this.poolMigrationFee = poolMigrationFee;\r\n    this.creatorFeeBasisPoints = creatorFeeBasisPoints;\r\n    this.reservedFeeRecipient = reservedFeeRecipient || PublicKey.default;\r\n    this.mayhemModeEnabled = mayhemModeEnabled;\r\n  }\r\n\r\n  getInitialBuyPrice(amount: bigint): bigint {\r\n    if (amount <= 0n) {\r\n      return 0n;\r\n    }\r\n\r\n    let n = this.initialVirtualSolReserves * this.initialVirtualTokenReserves;\r\n    let i = this.initialVirtualSolReserves + amount;\r\n    let r = n / i + 1n;\r\n    let s = this.initialVirtualTokenReserves - r;\r\n    return s < this.initialRealTokenReserves\r\n      ? s\r\n      : this.initialRealTokenReserves;\r\n  }\r\n\r\n  public static fromBuffer(buffer: Buffer): GlobalAccount {\r\n    // The Global account has been expanded significantly beyond the original 243/244 bytes\r\n    // We only need to read the first 243 or 244 bytes for the fields we care about\r\n    const minOldSize = 243;\r\n    const minNewSize = 244;\r\n\r\n    if (buffer.length < minOldSize) {\r\n      throw new Error(`Invalid GlobalAccount buffer size: ${buffer.length} (expected at least ${minOldSize})`);\r\n    }\r\n\r\n    // Check if we have the new fields by looking at byte 243\r\n    const hasNewFields = buffer.length >= minNewSize;\r\n    \r\n    // Use appropriate structure based on available data\r\n    const structure: Layout<GlobalAccount> = hasNewFields\r\n      ? struct([\r\n          u64(\"discriminator\"),\r\n          bool(\"initialized\"),\r\n          publicKey(\"authority\"),\r\n          publicKey(\"feeRecipient\"),\r\n          u64(\"initialVirtualTokenReserves\"),\r\n          u64(\"initialVirtualSolReserves\"),\r\n          u64(\"initialRealTokenReserves\"),\r\n          u64(\"tokenTotalSupply\"),\r\n          u64(\"feeBasisPoints\"),\r\n          publicKey(\"withdrawAuthority\"),\r\n          bool(\"enableMigrate\"),\r\n          u64(\"poolMigrationFee\"),\r\n          u64(\"creatorFeeBasisPoints\"),\r\n          publicKey(\"reservedFeeRecipient\"),\r\n          bool(\"mayhemModeEnabled\"),\r\n        ])\r\n      : struct([\r\n          u64(\"discriminator\"),\r\n          bool(\"initialized\"),\r\n          publicKey(\"authority\"),\r\n          publicKey(\"feeRecipient\"),\r\n          u64(\"initialVirtualTokenReserves\"),\r\n          u64(\"initialVirtualSolReserves\"),\r\n          u64(\"initialRealTokenReserves\"),\r\n          u64(\"tokenTotalSupply\"),\r\n          u64(\"feeBasisPoints\"),\r\n          publicKey(\"withdrawAuthority\"),\r\n          bool(\"enableMigrate\"),\r\n          u64(\"poolMigrationFee\"),\r\n          u64(\"creatorFeeBasisPoints\"),\r\n        ]);\r\n\r\n    // Only decode the bytes we need (first 243 or 244 bytes)\r\n    const bytesToDecode = hasNewFields ? minNewSize : minOldSize;\r\n    let value = structure.decode(buffer.subarray(0, bytesToDecode));\r\n    \r\n    return new GlobalAccount(\r\n      BigInt(value.discriminator),\r\n      value.initialized,\r\n      value.authority,\r\n      value.feeRecipient,\r\n      BigInt(value.initialVirtualTokenReserves),\r\n      BigInt(value.initialVirtualSolReserves),\r\n      BigInt(value.initialRealTokenReserves),\r\n      BigInt(value.tokenTotalSupply),\r\n      BigInt(value.feeBasisPoints),\r\n      value.withdrawAuthority,\r\n      value.enableMigrate,\r\n      BigInt(value.poolMigrationFee),\r\n      BigInt(value.creatorFeeBasisPoints),\r\n      hasNewFields ? (value as any).reservedFeeRecipient : PublicKey.default,\r\n      hasNewFields ? (value as any).mayhemModeEnabled : false\r\n    );\r\n  }\r\n}\r\n"],"names":["PublicKey","struct","u64","bool","publicKey"],"mappings":";;;;;MAGa,aAAa,CAAA;AACjB,IAAA,aAAa;IACb,WAAW,GAAY,KAAK;AAC5B,IAAA,SAAS;AACT,IAAA,YAAY;AACZ,IAAA,2BAA2B;AAC3B,IAAA,yBAAyB;AACzB,IAAA,wBAAwB;AACxB,IAAA,gBAAgB;AAChB,IAAA,cAAc;AACd,IAAA,iBAAiB;IACjB,aAAa,GAAY,KAAK;AAC9B,IAAA,gBAAgB;AAChB,IAAA,qBAAqB;AACrB,IAAA,oBAAoB;IACpB,iBAAiB,GAAY,KAAK;AAEzC,IAAA,WAAA,CACE,aAAqB,EACrB,WAAoB,EACpB,SAAoB,EACpB,YAAuB,EACvB,2BAAmC,EACnC,yBAAiC,EACjC,wBAAgC,EAChC,gBAAwB,EACxB,cAAsB,EACtB,iBAA4B,EAC5B,aAAsB,EACtB,gBAAwB,EACxB,qBAA6B,EAC7B,oBAAgC,EAChC,oBAA6B,KAAK,EAAA;AAElC,QAAA,IAAI,CAAC,aAAa,GAAG,aAAa;AAClC,QAAA,IAAI,CAAC,WAAW,GAAG,WAAW;AAC9B,QAAA,IAAI,CAAC,SAAS,GAAG,SAAS;AAC1B,QAAA,IAAI,CAAC,YAAY,GAAG,YAAY;AAChC,QAAA,IAAI,CAAC,2BAA2B,GAAG,2BAA2B;AAC9D,QAAA,IAAI,CAAC,yBAAyB,GAAG,yBAAyB;AAC1D,QAAA,IAAI,CAAC,wBAAwB,GAAG,wBAAwB;AACxD,QAAA,IAAI,CAAC,gBAAgB,GAAG,gBAAgB;AACxC,QAAA,IAAI,CAAC,cAAc,GAAG,cAAc;AACpC,QAAA,IAAI,CAAC,iBAAiB,GAAG,iBAAiB;AAC1C,QAAA,IAAI,CAAC,aAAa,GAAG,aAAa;AAClC,QAAA,IAAI,CAAC,gBAAgB,GAAG,gBAAgB;AACxC,QAAA,IAAI,CAAC,qBAAqB,GAAG,qBAAqB;QAClD,IAAI,CAAC,oBAAoB,GAAG,oBAAoB,IAAIA,iBAAS,CAAC,OAAO;AACrE,QAAA,IAAI,CAAC,iBAAiB,GAAG,iBAAiB;IAC5C;AAEA,IAAA,kBAAkB,CAAC,MAAc,EAAA;AAC/B,QAAA,IAAI,MAAM,IAAI,EAAE,EAAE;AAChB,YAAA,OAAO,EAAE;QACX;QAEA,IAAI,CAAC,GAAG,IAAI,CAAC,yBAAyB,GAAG,IAAI,CAAC,2BAA2B;AACzE,QAAA,IAAI,CAAC,GAAG,IAAI,CAAC,yBAAyB,GAAG,MAAM;AAC/C,QAAA,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,GAAG,EAAE;AAClB,QAAA,IAAI,CAAC,GAAG,IAAI,CAAC,2BAA2B,GAAG,CAAC;AAC5C,QAAA,OAAO,CAAC,GAAG,IAAI,CAAC;AACd,cAAE;AACF,cAAE,IAAI,CAAC,wBAAwB;IACnC;IAEO,OAAO,UAAU,CAAC,MAAc,EAAA;;;QAGrC,MAAM,UAAU,GAAG,GAAG;QACtB,MAAM,UAAU,GAAG,GAAG;AAEtB,QAAA,IAAI,MAAM,CAAC,MAAM,GAAG,UAAU,EAAE;YAC9B,MAAM,IAAI,KAAK,CAAC,CAAA,mCAAA,EAAsC,MAAM,CAAC,MAAM,CAAA,oBAAA,EAAuB,UAAU,CAAA,CAAA,CAAG,CAAC;QAC1G;;AAGA,QAAA,MAAM,YAAY,GAAG,MAAM,CAAC,MAAM,IAAI,UAAU;;QAGhD,MAAM,SAAS,GAA0B;cACrCC,YAAM,CAAC;gBACLC,SAAG,CAAC,eAAe,CAAC;gBACpBC,UAAI,CAAC,aAAa,CAAC;gBACnBC,eAAS,CAAC,WAAW,CAAC;gBACtBA,eAAS,CAAC,cAAc,CAAC;gBACzBF,SAAG,CAAC,6BAA6B,CAAC;gBAClCA,SAAG,CAAC,2BAA2B,CAAC;gBAChCA,SAAG,CAAC,0BAA0B,CAAC;gBAC/BA,SAAG,CAAC,kBAAkB,CAAC;gBACvBA,SAAG,CAAC,gBAAgB,CAAC;gBACrBE,eAAS,CAAC,mBAAmB,CAAC;gBAC9BD,UAAI,CAAC,eAAe,CAAC;gBACrBD,SAAG,CAAC,kBAAkB,CAAC;gBACvBA,SAAG,CAAC,uBAAuB,CAAC;gBAC5BE,eAAS,CAAC,sBAAsB,CAAC;gBACjCD,UAAI,CAAC,mBAAmB,CAAC;aAC1B;cACDF,YAAM,CAAC;gBACLC,SAAG,CAAC,eAAe,CAAC;gBACpBC,UAAI,CAAC,aAAa,CAAC;gBACnBC,eAAS,CAAC,WAAW,CAAC;gBACtBA,eAAS,CAAC,cAAc,CAAC;gBACzBF,SAAG,CAAC,6BAA6B,CAAC;gBAClCA,SAAG,CAAC,2BAA2B,CAAC;gBAChCA,SAAG,CAAC,0BAA0B,CAAC;gBAC/BA,SAAG,CAAC,kBAAkB,CAAC;gBACvBA,SAAG,CAAC,gBAAgB,CAAC;gBACrBE,eAAS,CAAC,mBAAmB,CAAC;gBAC9BD,UAAI,CAAC,eAAe,CAAC;gBACrBD,SAAG,CAAC,kBAAkB,CAAC;gBACvBA,SAAG,CAAC,uBAAuB,CAAC;AAC7B,aAAA,CAAC;;QAGN,MAAM,aAAa,GAAG,YAAY,GAAG,UAAU,GAAG,UAAU;AAC5D,QAAA,IAAI,KAAK,GAAG,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,EAAE,aAAa,CAAC,CAAC;QAE/D,OAAO,IAAI,aAAa,CACtB,MAAM,CAAC,KAAK,CAAC,aAAa,CAAC,EAC3B,KAAK,CAAC,WAAW,EACjB,KAAK,CAAC,SAAS,EACf,KAAK,CAAC,YAAY,EAClB,MAAM,CAAC,KAAK,CAAC,2BAA2B,CAAC,EACzC,MAAM,CAAC,KAAK,CAAC,yBAAyB,CAAC,EACvC,MAAM,CAAC,KAAK,CAAC,wBAAwB,CAAC,EACtC,MAAM,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAC9B,MAAM,CAAC,KAAK,CAAC,cAAc,CAAC,EAC5B,KAAK,CAAC,iBAAiB,EACvB,KAAK,CAAC,aAAa,EACnB,MAAM,CAAC,KAAK,CAAC,gBAAgB,CAAC,EAC9B,MAAM,CAAC,KAAK,CAAC,qBAAqB,CAAC,EACnC,YAAY,GAAI,KAAa,CAAC,oBAAoB,GAAGF,iBAAS,CAAC,OAAO,EACtE,YAAY,GAAI,KAAa,CAAC,iBAAiB,GAAG,KAAK,CACxD;IACH;AACD;;;;"}