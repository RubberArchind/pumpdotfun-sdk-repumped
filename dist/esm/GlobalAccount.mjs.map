{"version":3,"file":"GlobalAccount.mjs","sources":["../../../src/GlobalAccount.ts"],"sourcesContent":["import { PublicKey } from \"@solana/web3.js\";\r\nimport { struct, bool, u64, publicKey, Layout } from \"@coral-xyz/borsh\";\r\n\r\nexport class GlobalAccount {\r\n  public discriminator: bigint;\r\n  public initialized: boolean = false;\r\n  public authority: PublicKey;\r\n  public feeRecipient: PublicKey;\r\n  public initialVirtualTokenReserves: bigint;\r\n  public initialVirtualSolReserves: bigint;\r\n  public initialRealTokenReserves: bigint;\r\n  public tokenTotalSupply: bigint;\r\n  public feeBasisPoints: bigint;\r\n  public withdrawAuthority: PublicKey;\r\n  public enableMigrate: boolean = false;\r\n  public poolMigrationFee: bigint;\r\n  public creatorFeeBasisPoints: bigint;\r\n  public reservedFeeRecipient: PublicKey;\r\n  public mayhemModeEnabled: boolean = false;\r\n\r\n  constructor(\r\n    discriminator: bigint,\r\n    initialized: boolean,\r\n    authority: PublicKey,\r\n    feeRecipient: PublicKey,\r\n    initialVirtualTokenReserves: bigint,\r\n    initialVirtualSolReserves: bigint,\r\n    initialRealTokenReserves: bigint,\r\n    tokenTotalSupply: bigint,\r\n    feeBasisPoints: bigint,\r\n    withdrawAuthority: PublicKey,\r\n    enableMigrate: boolean,\r\n    poolMigrationFee: bigint,\r\n    creatorFeeBasisPoints: bigint,\r\n    reservedFeeRecipient?: PublicKey,\r\n    mayhemModeEnabled: boolean = false\r\n  ) {\r\n    this.discriminator = discriminator;\r\n    this.initialized = initialized;\r\n    this.authority = authority;\r\n    this.feeRecipient = feeRecipient;\r\n    this.initialVirtualTokenReserves = initialVirtualTokenReserves;\r\n    this.initialVirtualSolReserves = initialVirtualSolReserves;\r\n    this.initialRealTokenReserves = initialRealTokenReserves;\r\n    this.tokenTotalSupply = tokenTotalSupply;\r\n    this.feeBasisPoints = feeBasisPoints;\r\n    this.withdrawAuthority = withdrawAuthority;\r\n    this.enableMigrate = enableMigrate;\r\n    this.poolMigrationFee = poolMigrationFee;\r\n    this.creatorFeeBasisPoints = creatorFeeBasisPoints;\r\n    this.reservedFeeRecipient = reservedFeeRecipient || PublicKey.default;\r\n    this.mayhemModeEnabled = mayhemModeEnabled;\r\n  }\r\n\r\n  getInitialBuyPrice(amount: bigint): bigint {\r\n    if (amount <= 0n) {\r\n      return 0n;\r\n    }\r\n\r\n    let n = this.initialVirtualSolReserves * this.initialVirtualTokenReserves;\r\n    let i = this.initialVirtualSolReserves + amount;\r\n    let r = n / i + 1n;\r\n    let s = this.initialVirtualTokenReserves - r;\r\n    return s < this.initialRealTokenReserves\r\n      ? s\r\n      : this.initialRealTokenReserves;\r\n  }\r\n\r\n  public static fromBuffer(buffer: Buffer): GlobalAccount {\r\n    // Check buffer size to determine if it's old (243 bytes) or new (244 bytes) format\r\n    const isOldFormat = buffer.length === 243;\r\n    const isNewFormat = buffer.length === 244;\r\n\r\n    if (!isOldFormat && !isNewFormat) {\r\n      throw new Error(`Invalid GlobalAccount buffer size: ${buffer.length} (expected 243 or 244)`);\r\n    }\r\n\r\n    // Use appropriate structure based on buffer size\r\n    const structure: Layout<GlobalAccount> = isOldFormat\r\n      ? struct([\r\n          u64(\"discriminator\"),\r\n          bool(\"initialized\"),\r\n          publicKey(\"authority\"),\r\n          publicKey(\"feeRecipient\"),\r\n          u64(\"initialVirtualTokenReserves\"),\r\n          u64(\"initialVirtualSolReserves\"),\r\n          u64(\"initialRealTokenReserves\"),\r\n          u64(\"tokenTotalSupply\"),\r\n          u64(\"feeBasisPoints\"),\r\n          publicKey(\"withdrawAuthority\"),\r\n          bool(\"enableMigrate\"),\r\n          u64(\"poolMigrationFee\"),\r\n          u64(\"creatorFeeBasisPoints\"),\r\n        ])\r\n      : struct([\r\n          u64(\"discriminator\"),\r\n          bool(\"initialized\"),\r\n          publicKey(\"authority\"),\r\n          publicKey(\"feeRecipient\"),\r\n          u64(\"initialVirtualTokenReserves\"),\r\n          u64(\"initialVirtualSolReserves\"),\r\n          u64(\"initialRealTokenReserves\"),\r\n          u64(\"tokenTotalSupply\"),\r\n          u64(\"feeBasisPoints\"),\r\n          publicKey(\"withdrawAuthority\"),\r\n          bool(\"enableMigrate\"),\r\n          u64(\"poolMigrationFee\"),\r\n          u64(\"creatorFeeBasisPoints\"),\r\n          publicKey(\"reservedFeeRecipient\"),\r\n          bool(\"mayhemModeEnabled\"),\r\n        ]);\r\n\r\n    let value = structure.decode(buffer);\r\n    return new GlobalAccount(\r\n      BigInt(value.discriminator),\r\n      value.initialized,\r\n      value.authority,\r\n      value.feeRecipient,\r\n      BigInt(value.initialVirtualTokenReserves),\r\n      BigInt(value.initialVirtualSolReserves),\r\n      BigInt(value.initialRealTokenReserves),\r\n      BigInt(value.tokenTotalSupply),\r\n      BigInt(value.feeBasisPoints),\r\n      value.withdrawAuthority,\r\n      value.enableMigrate,\r\n      BigInt(value.poolMigrationFee),\r\n      BigInt(value.creatorFeeBasisPoints),\r\n      isOldFormat ? PublicKey.default : (value as any).reservedFeeRecipient,\r\n      isOldFormat ? false : (value as any).mayhemModeEnabled\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}