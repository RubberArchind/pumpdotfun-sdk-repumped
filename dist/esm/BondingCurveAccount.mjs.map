{"version":3,"file":"BondingCurveAccount.mjs","sources":["../../../src/BondingCurveAccount.ts"],"sourcesContent":["import { struct, bool, u64, Layout, publicKey } from \"@coral-xyz/borsh\";\r\nimport { PublicKey } from \"@solana/web3.js\";\r\nimport { FeeConfig } from \"./FeeConfig.js\";\r\nimport { GlobalAccount } from \"./GlobalAccount.js\";\r\n\r\nexport class BondingCurveAccount {\r\n  public discriminator: bigint;\r\n  public virtualTokenReserves: bigint;\r\n  public virtualSolReserves: bigint;\r\n  public realTokenReserves: bigint;\r\n  public realSolReserves: bigint;\r\n  public tokenTotalSupply: bigint;\r\n  public complete: boolean;\r\n  public creator: PublicKey;\r\n  public isMayhemMode: boolean;\r\n\r\n  constructor(\r\n    discriminator: bigint,\r\n    virtualTokenReserves: bigint,\r\n    virtualSolReserves: bigint,\r\n    realTokenReserves: bigint,\r\n    realSolReserves: bigint,\r\n    tokenTotalSupply: bigint,\r\n    complete: boolean,\r\n    creator: PublicKey,\r\n    isMayhemMode: boolean = false\r\n  ) {\r\n    this.discriminator = discriminator;\r\n    this.virtualTokenReserves = virtualTokenReserves;\r\n    this.virtualSolReserves = virtualSolReserves;\r\n    this.realTokenReserves = realTokenReserves;\r\n    this.realSolReserves = realSolReserves;\r\n    this.tokenTotalSupply = tokenTotalSupply;\r\n    this.complete = complete;\r\n    this.creator = creator;\r\n    this.isMayhemMode = isMayhemMode;\r\n  }\r\n\r\n  getBuyPrice(\r\n    globalAccount: GlobalAccount,\r\n    feeConfig: FeeConfig,\r\n    amount: bigint\r\n  ): bigint {\r\n    if (this.complete) {\r\n      throw new Error(\"Curve is complete\");\r\n    }\r\n\r\n    if (amount <= 0n) {\r\n      return 0n;\r\n    }\r\n    if (this.virtualTokenReserves === 0n) {\r\n      return 0n;\r\n    }\r\n    const { protocolFeeBps, creatorFeeBps } = feeConfig.computeFeesBps({\r\n      global: globalAccount,\r\n      virtualSolReserves: this.virtualSolReserves,\r\n      virtualTokenReserves: this.virtualTokenReserves,\r\n    });\r\n    const totalFeeBasisPoints =\r\n      protocolFeeBps +\r\n      (!PublicKey.default.equals(this.creator) ? creatorFeeBps : 0n);\r\n\r\n    const inputAmount = (amount * 10_000n) / (totalFeeBasisPoints + 10_000n);\r\n\r\n    const tokensReceived = this.getBuyTokenAmountFromSolAmountQuote({\r\n      inputAmount,\r\n      virtualTokenReserves: this.virtualTokenReserves,\r\n      virtualSolReserves: this.virtualSolReserves,\r\n    });\r\n\r\n    return tokensReceived < this.realTokenReserves\r\n      ? tokensReceived\r\n      : this.realTokenReserves;\r\n  }\r\n\r\n  getBuyTokenAmountFromSolAmountQuote({\r\n    inputAmount,\r\n    virtualTokenReserves,\r\n    virtualSolReserves,\r\n  }: {\r\n    inputAmount: bigint;\r\n    virtualTokenReserves: bigint;\r\n    virtualSolReserves: bigint;\r\n  }): bigint {\r\n    return (\r\n      (inputAmount * virtualTokenReserves) / (virtualSolReserves + inputAmount)\r\n    );\r\n  }\r\n\r\n  getSellSolAmountFromTokenAmountQuote({\r\n    inputAmount,\r\n    virtualTokenReserves,\r\n    virtualSolReserves,\r\n  }: {\r\n    inputAmount: bigint;\r\n    virtualTokenReserves: bigint;\r\n    virtualSolReserves: bigint;\r\n  }): bigint {\r\n    return (\r\n      (inputAmount * virtualSolReserves) / (virtualTokenReserves + inputAmount)\r\n    );\r\n  }\r\n\r\n  getSellPrice(\r\n    globalAccount: GlobalAccount,\r\n    feeConfig: FeeConfig,\r\n    amount: bigint\r\n  ): bigint {\r\n    if (this.complete) {\r\n      throw new Error(\"Curve is complete\");\r\n    }\r\n\r\n    if (amount <= 0n) {\r\n      return 0n;\r\n    }\r\n    if (this.virtualTokenReserves === 0n) {\r\n      return 0n;\r\n    }\r\n    const solCost = this.getSellSolAmountFromTokenAmountQuote({\r\n      inputAmount: amount,\r\n      virtualTokenReserves: this.virtualTokenReserves,\r\n      virtualSolReserves: this.virtualSolReserves,\r\n    });\r\n\r\n    const fee = feeConfig.getFee({\r\n      global: globalAccount,\r\n      bondingCurve: this,\r\n      amount: solCost,\r\n      isNewBondingCurve: false,\r\n    });\r\n    return solCost - fee;\r\n  }\r\n\r\n  getMarketCapSOL(): bigint {\r\n    if (this.virtualTokenReserves === 0n) {\r\n      return 0n;\r\n    }\r\n\r\n    return (\r\n      (this.tokenTotalSupply * this.virtualSolReserves) /\r\n      this.virtualTokenReserves\r\n    );\r\n  }\r\n\r\n  getFinalMarketCapSOL(mintSupply: bigint): bigint {\r\n    return (this.virtualSolReserves * mintSupply) / this.virtualTokenReserves;\r\n  }\r\n\r\n  public static fromBuffer(buffer: Buffer): BondingCurveAccount {\r\n    const structure: Layout<BondingCurveAccount> = struct([\r\n      u64(\"discriminator\"),\r\n      u64(\"virtualTokenReserves\"),\r\n      u64(\"virtualSolReserves\"),\r\n      u64(\"realTokenReserves\"),\r\n      u64(\"realSolReserves\"),\r\n      u64(\"tokenTotalSupply\"),\r\n      bool(\"complete\"),\r\n      publicKey(\"creator\"),\r\n      bool(\"isMayhemMode\"),\r\n    ]);\r\n\r\n    let value = structure.decode(buffer);\r\n    return new BondingCurveAccount(\r\n      BigInt(value.discriminator),\r\n      BigInt(value.virtualTokenReserves),\r\n      BigInt(value.virtualSolReserves),\r\n      BigInt(value.realTokenReserves),\r\n      BigInt(value.realSolReserves),\r\n      BigInt(value.tokenTotalSupply),\r\n      value.complete,\r\n      value.creator,\r\n      value.isMayhemMode\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}