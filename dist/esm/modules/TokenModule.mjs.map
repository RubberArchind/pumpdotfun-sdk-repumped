{"version":3,"file":"TokenModule.mjs","sources":["../../../../src/modules/TokenModule.ts"],"sourcesContent":["import {\r\n  createAssociatedTokenAccountInstruction,\r\n  getAccount,\r\n  getAssociatedTokenAddress,\r\n  TOKEN_2022_PROGRAM_ID,\r\n  TOKEN_PROGRAM_ID,\r\n} from \"@solana/spl-token\";\r\nimport { PublicKey, Transaction, Commitment } from \"@solana/web3.js\";\r\nimport { DEFAULT_COMMITMENT } from \"../pumpFun.consts.js\";\r\nimport { CreateTokenMetadata } from \"../pumpFun.types.js\";\r\nimport { PumpFunSDK } from \"../PumpFunSDK.js\";\r\nimport { BondingCurveAccount } from \"../BondingCurveAccount.js\";\r\nimport { GlobalAccount } from \"../GlobalAccount.js\";\r\nimport { FeeConfig } from \"../FeeConfig.js\";\r\n\r\nexport class TokenModule {\r\n  constructor(private sdk: PumpFunSDK) {}\r\n\r\n  async createTokenMetadata(create: CreateTokenMetadata) {\r\n    // Validate file\r\n    if (!(create.file instanceof Blob)) {\r\n      throw new Error(\"File must be a Blob or File object\");\r\n    }\r\n\r\n    let formData = new FormData();\r\n    formData.append(\"file\", create.file, \"image.png\"); // Add filename\r\n    formData.append(\"name\", create.name);\r\n    formData.append(\"symbol\", create.symbol);\r\n    formData.append(\"description\", create.description);\r\n    formData.append(\"twitter\", create.twitter || \"\");\r\n    formData.append(\"telegram\", create.telegram || \"\");\r\n    formData.append(\"website\", create.website || \"\");\r\n    formData.append(\"showName\", \"true\");\r\n\r\n    try {\r\n      const request = await fetch(\"https://pump.fun/api/ipfs\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          Accept: \"application/json\",\r\n        },\r\n        body: formData,\r\n        credentials: \"same-origin\",\r\n      });\r\n\r\n      if (request.status === 500) {\r\n        // Try to get more error details\r\n        const errorText = await request.text();\r\n        throw new Error(\r\n          `Server error (500): ${errorText || \"No error details available\"}`\r\n        );\r\n      }\r\n\r\n      if (!request.ok) {\r\n        throw new Error(`HTTP error! status: ${request.status}`);\r\n      }\r\n\r\n      const responseText = await request.text();\r\n      if (!responseText) {\r\n        throw new Error(\"Empty response received from server\");\r\n      }\r\n\r\n      try {\r\n        return JSON.parse(responseText);\r\n      } catch (e) {\r\n        throw new Error(`Invalid JSON response: ${responseText}`);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error in createTokenMetadata:\", error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createAssociatedTokenAccountIfNeeded(\r\n    payer: PublicKey,\r\n    owner: PublicKey,\r\n    mint: PublicKey,\r\n    transaction: Transaction,\r\n    commitment: Commitment = DEFAULT_COMMITMENT\r\n  ): Promise<PublicKey> {\r\n    // Detect which token program this mint uses\r\n    const mintAccount = await this.sdk.connection.getAccountInfo(mint, commitment);\r\n    if (!mintAccount) {\r\n      throw new Error(`Mint account not found: ${mint.toBase58()}`);\r\n    }\r\n    \r\n    // Determine if this is a Token2022 mint by checking the owner\r\n    const tokenProgramId = mintAccount.owner.equals(TOKEN_2022_PROGRAM_ID)\r\n      ? TOKEN_2022_PROGRAM_ID\r\n      : TOKEN_PROGRAM_ID;\r\n    \r\n    const associatedTokenAccount = await getAssociatedTokenAddress(\r\n      mint,\r\n      owner,\r\n      false,\r\n      tokenProgramId\r\n    );\r\n\r\n    try {\r\n      await getAccount(this.sdk.connection, associatedTokenAccount, commitment, tokenProgramId);\r\n    } catch (e) {\r\n      transaction.add(\r\n        createAssociatedTokenAccountInstruction(\r\n          payer,\r\n          associatedTokenAccount,\r\n          owner,\r\n          mint,\r\n          tokenProgramId\r\n        )\r\n      );\r\n    }\r\n\r\n    return associatedTokenAccount;\r\n  }\r\n\r\n  async getBondingCurveAccount(\r\n    mint: PublicKey,\r\n    commitmentOrTokenProgram?: Commitment | PublicKey,\r\n    commitment: Commitment = DEFAULT_COMMITMENT\r\n  ) {\r\n    // Handle overloaded parameters - if second param is PublicKey, it's tokenProgram\r\n    let tokenProgram: PublicKey | undefined;\r\n    let actualCommitment: Commitment;\r\n    \r\n    if (commitmentOrTokenProgram instanceof PublicKey) {\r\n      tokenProgram = commitmentOrTokenProgram;\r\n      actualCommitment = commitment;\r\n    } else {\r\n      tokenProgram = undefined;\r\n      actualCommitment = commitmentOrTokenProgram || commitment;\r\n    }\r\n    \r\n    const tokenAccount = await this.sdk.connection.getAccountInfo(\r\n      this.sdk.pda.getBondingCurvePDA(mint, tokenProgram),\r\n      actualCommitment\r\n    );\r\n    if (!tokenAccount) {\r\n      return null;\r\n    }\r\n    // Note: Bonding curve accounts do NOT have the 8-byte Anchor discriminator\r\n    // Parse the data directly without skipping bytes\r\n    return BondingCurveAccount.fromBuffer(tokenAccount.data);\r\n  }\r\n\r\n  async getGlobalAccount(commitment: Commitment = DEFAULT_COMMITMENT) {\r\n    const globalAccountPDA = this.sdk.pda.getGlobalAccountPda();\r\n\r\n    const tokenAccount = await this.sdk.connection.getAccountInfo(\r\n      globalAccountPDA,\r\n      commitment\r\n    );\r\n\r\n    // Note: Global account does NOT have the 8-byte Anchor discriminator\r\n    // Parse the data directly without skipping bytes\r\n    return GlobalAccount.fromBuffer(tokenAccount!.data);\r\n  }\r\n\r\n  async getFeeConfig(commitment: Commitment = DEFAULT_COMMITMENT) {\r\n    const feePda = this.sdk.pda.getPumpFeeConfigPda();\r\n    // @ts-ignore: feeConfig account is missing in generated Anchor types\r\n    const anchorFee = await this.sdk.program.account.feeConfig.fetch(feePda);\r\n    return FeeConfig.convert(anchorFee);\r\n  }\r\n\r\n  async getBondingCurveCreator(\r\n    bondingCurvePDA: PublicKey,\r\n    commitment: Commitment = DEFAULT_COMMITMENT\r\n  ): Promise<PublicKey> {\r\n    const bondingAccountInfo = await this.sdk.connection.getAccountInfo(\r\n      bondingCurvePDA,\r\n      commitment\r\n    );\r\n    if (!bondingAccountInfo) {\r\n      throw new Error(\"Bonding curve account not found\");\r\n    }\r\n\r\n    // Creator is at offset 49 (after 8 bytes discriminator, 5 u64 fields, and 1 byte boolean)\r\n    const creatorBytes = bondingAccountInfo.data.subarray(49, 49 + 32);\r\n    return new PublicKey(creatorBytes);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}