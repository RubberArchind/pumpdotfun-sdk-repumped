{"version":3,"file":"AstraModule.mjs","sources":["../../../../src/modules/AstraModule.ts"],"sourcesContent":["import { PumpFunSDK } from \"../PumpFunSDK.js\";\r\nimport {\r\n  Commitment,\r\n  Keypair,\r\n  PublicKey,\r\n  SystemProgram,\r\n  Transaction,\r\n  VersionedTransaction,\r\n} from \"@solana/web3.js\";\r\nimport { DEFAULT_COMMITMENT, getHealthBody } from \"../pumpFun.consts.js\";\r\nimport { PriorityFee, Region } from \"../pumpFun.types.js\";\r\nimport {\r\n  calculateWithSlippageBuy,\r\n  calculateWithSlippageSell,\r\n} from \"../slippage.js\";\r\nimport { buildSignedTx } from \"../tx.js\";\r\nimport AgentRegistry from \"../AgentRegistry.js\";\r\n\r\nexport class AstraModule {\r\n  private key: string;\r\n  constructor(private sdk: PumpFunSDK, region: Region, key: string) {\r\n    AgentRegistry.registerInConfig(\"astra\", region);\r\n    this.key = key;\r\n  }\r\n\r\n  ASTRA_ACCOUNTS = [\r\n    new PublicKey(\"astrazznxsGUhWShqgNtAdfrzP2G83DzcWVJDxwV9bF\"),\r\n    new PublicKey(\"astra4uejePWneqNaJKuFFA8oonqCE1sqF6b45kDMZm\"),\r\n    new PublicKey(\"astra9xWY93QyfG6yM8zwsKsRodscjQ2uU2HKNL5prk\"),\r\n    new PublicKey(\"astraRVUuTHjpwEVvNBeQEgwYx9w9CFyfxjYoobCZhL\"),\r\n  ];\r\n\r\n  private getRandomAccount() {\r\n    const randomIndex = Math.floor(Math.random() * this.ASTRA_ACCOUNTS.length);\r\n    return this.ASTRA_ACCOUNTS[randomIndex];\r\n  }\r\n\r\n  async buy(\r\n    buyer: Keypair,\r\n    mint: PublicKey,\r\n    buyAmountSol: bigint,\r\n    slippageBasisPoints: bigint = 500n,\r\n    tip: number = 500000,\r\n    priorityFees?: PriorityFee,\r\n    commitment: Commitment = DEFAULT_COMMITMENT\r\n  ): Promise<string> {\r\n    const bondingAccount = await this.sdk.token.getBondingCurveAccount(\r\n      mint,\r\n      commitment\r\n    );\r\n    if (!bondingAccount) {\r\n      throw new Error(`Bonding curve account not found: ${mint.toBase58()}`);\r\n    }\r\n    const feeConfig = await this.sdk.token.getFeeConfig(commitment);\r\n    const globalAccount = await this.sdk.token.getGlobalAccount(commitment);\r\n    const buyAmount = bondingAccount.getBuyPrice(\r\n      globalAccount,\r\n      feeConfig,\r\n      buyAmountSol\r\n    );\r\n    const buyAmountWithSlippage = calculateWithSlippageBuy(\r\n      buyAmountSol,\r\n      slippageBasisPoints\r\n    );\r\n\r\n    const transaction = new Transaction();\r\n    await this.sdk.trade.buildBuyIx(\r\n      buyer.publicKey,\r\n      mint,\r\n      buyAmount,\r\n      buyAmountWithSlippage,\r\n      transaction,\r\n      commitment,\r\n      false\r\n    );\r\n    this.addTip(buyer, transaction, tip);\r\n    const signedTx = await buildSignedTx(\r\n      priorityFees,\r\n      transaction,\r\n      this.sdk.connection,\r\n      buyer.publicKey,\r\n      commitment,\r\n      [buyer]\r\n    );\r\n    return await this.sendTransaction(signedTx);\r\n  }\r\n\r\n  async sell(\r\n    seller: Keypair,\r\n    mint: PublicKey,\r\n    sellTokenAmount: bigint,\r\n    slippageBasisPoints: bigint = 500n,\r\n    tip: number = 500000,\r\n    priorityFees?: PriorityFee,\r\n    commitment: Commitment = DEFAULT_COMMITMENT\r\n  ): Promise<string> {\r\n    const bondingAccount = await this.sdk.token.getBondingCurveAccount(\r\n      mint,\r\n      commitment\r\n    );\r\n    if (!bondingAccount)\r\n      throw new Error(`Bonding curve account not found: ${mint.toBase58()}`);\r\n\r\n    const globalAccount = await this.sdk.token.getGlobalAccount(commitment);\r\n    const feeConfig = await this.sdk.token.getFeeConfig(commitment);\r\n\r\n    const minSolOutput = bondingAccount.getSellPrice(\r\n      globalAccount,\r\n      feeConfig,\r\n      sellTokenAmount\r\n    );\r\n    let sellAmountWithSlippage = calculateWithSlippageSell(\r\n      minSolOutput,\r\n      slippageBasisPoints\r\n    );\r\n    if (sellAmountWithSlippage < 1n) sellAmountWithSlippage = 1n;\r\n\r\n    const transaction = new Transaction();\r\n    await this.sdk.trade.buildSellIx(\r\n      seller.publicKey,\r\n      mint,\r\n      sellTokenAmount,\r\n      sellAmountWithSlippage,\r\n      transaction,\r\n      commitment\r\n    );\r\n\r\n    this.addTip(seller, transaction, tip);\r\n    const signedTx = await buildSignedTx(\r\n      priorityFees,\r\n      transaction,\r\n      this.sdk.connection,\r\n      seller.publicKey,\r\n      commitment,\r\n      [seller]\r\n    );\r\n\r\n    return await this.sendTransaction(signedTx);\r\n  }\r\n\r\n  private addTip(\r\n    buyer: Keypair,\r\n    transaction: Transaction,\r\n    tip: number = 500000\r\n  ): Transaction {\r\n    if (tip <= 0) {\r\n      return transaction;\r\n    }\r\n    const tipAccount = this.getRandomAccount();\r\n    const tipInstructions = SystemProgram.transfer({\r\n      fromPubkey: buyer.publicKey,\r\n      toPubkey: tipAccount,\r\n      lamports: tip,\r\n    });\r\n    transaction.add(tipInstructions);\r\n    return transaction;\r\n  }\r\n\r\n  async ping() {\r\n    return await AgentRegistry.callUpstream(\r\n      \"astra\",\r\n      `/iris?api-key=${this.key}`,\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Content-Length\": Buffer.byteLength(getHealthBody),\r\n        },\r\n        body: getHealthBody,\r\n      }\r\n    );\r\n  }\r\n\r\n  async sendTransaction(vertionedTx: VersionedTransaction) {\r\n    const serealized = vertionedTx.serialize();\r\n    const tx = Buffer.from(serealized).toString(\"base64\");\r\n    const UUID = crypto.randomUUID();\r\n    const txbody = JSON.stringify({\r\n      jsonrpc: \"2.0\",\r\n      id: UUID,\r\n      method: \"sendTransaction\",\r\n      params: [tx, { encoding: \"base64\", skipPreflight: true, maxRetries: 0 }],\r\n    });\r\n    return await AgentRegistry.callUpstream(\r\n      \"astra\",\r\n      `/iris?api-key=${this.key}`,\r\n      {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"Content-Length\": Buffer.byteLength(txbody),\r\n        },\r\n        body: txbody,\r\n      }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}